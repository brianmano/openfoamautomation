FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}
castellatedMesh true;
snap            true;
addLayers       true;  // Changed to enable boundary layers
 
geometry
{
    airfoil.stl
    {
        type triSurfaceMesh;
        name airfoil;
    }
   
    // Nearfield refinement box around airfoil
    nearfield
    {
        type searchableBox;
        min (-2.0 -1.0 0.0);     // Adjust coordinates based on your airfoil position
        max ( 4.0  1.0 0.01);    // Extend further downstream for wake capture
    }
   
}
 
castellatedMeshControls
{
    maxLocalCells       1000000;  // Increased for boundary layers
    maxGlobalCells      2000000; // Increased for boundary layers
    minRefinementCells  10;
    nCellsBetweenLevels 2;
 
    features
    (
        {
            file "airfoil.eMesh";
            level 2;
        }
    );
 
    refinementSurfaces
    {
        airfoil
        {
            level (2 2);  // Increased refinement for better boundary layer attachment
            patchInfo
            {
                type wall;
            }
        }
    }
 
    refinementRegions
    {
        nearfield
        {
            mode inside;
            levels ((1E15 1));  // Level 2 refinement in nearfield
        }
       
    }
 
    resolveFeatureAngle 20;
    locationInMesh      (0 0.5 0.005);
    allowFreeStandingZoneFaces true;
}
 
snapControls
{
    nSmoothPatch 3;
    tolerance    2.0;
    nSolveIter   30;
    nRelaxIter   5;
    nFeatureSnapIter 10;
    explicitFeatureSnap    false;
    implicitFeatureSnap    true;
}
 
addLayersControls
{
    relativeSizes true;
   
    layers
    {
        airfoil
        {
            nSurfaceLayers 10;  // Number of boundary layers
        }
    }
   
    // Boundary layer parameters
    expansionRatio    1.2;      // Growth ratio between layers
    finalLayerThickness 0.5;    // Thickness of final layer (relative to base mesh)
    minThickness      0.1;      // Minimum layer thickness (relative)
   
    // Advanced layer controls
    nGrow             0;        // Number of buffer cells around layer cells
    featureAngle      60;       // Feature angle for layers
    slipFeatureAngle  30;       // Slip on feature edges
    nRelaxIter        3;        // Relaxation iterations
    nSmoothSurfaceNormals 1;    // Smoothing of surface normals
    nSmoothNormals    3;        // Smoothing of normals
    nSmoothThickness  10;       // Smoothing of layer thickness
    maxFaceThicknessRatio 0.5;  // Max ratio of layer thickness to face size
    maxThicknessToMedialRatio 0.3; // Max ratio to medial axis
    minMedialAxisAngle 90;      // Angle criterion for medial axis
    nBufferCellsNoExtrude 0;    // Buffer cells where no extrusion
    nLayerIter        50;       // Maximum layer iterations
    nRelaxedIter      20;       // Relaxed iterations if not converged
}
 
meshQualityControls
{
    // Relaxed quality controls for boundary layer meshing
    maxNonOrtho          70;    // Slightly relaxed for layers
    maxBoundarySkewness  20;
    maxInternalSkewness  4;
    maxConcave           80;
    minVol               1e-13;
    minTetQuality        1e-30; // Much more relaxed for layers
    minArea              -1;
    minTwist             0.02;
    minDeterminant       0.001;
    minFaceWeight        0.02;  // Relaxed for layers
    minVolRatio          0.01;
    minTriangleTwist     -1;
    nSmoothScale         4;
    errorReduction       0.75;
   
    // Additional quality controls for layers
    relaxed
    {
        maxNonOrtho         75;
        maxBoundarySkewness 25;
        maxInternalSkewness 8;
        maxConcave          80;
        minVol              1e-20;
        minTetQuality       1e-50;
        minArea             -1;
        minTwist            0.001;
        minDeterminant      1e-6;
        minFaceWeight       1e-6;
        minVolRatio         1e-6;
        minTriangleTwist    -1;
    }
}
 
debug          0;
mergeTolerance 1e-6;
